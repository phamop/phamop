' ... (HA-Grafana existing definitions and setup)

package "Security & Identity Foundation" <<Security>> #AB47BC {
  component "Azure Active Directory" as AAD #AB47BC
  component "Azure Key Vault\n(Secrets, Certs, Keys)" as KV #AB47BC
  component "Managed Identities\n(for VMSS & Apps)" as MI #AB47BC
  database "Azure Monitor\n(Activity & Key Vault Logs)" as Audit #AB47BC
}

' ... (HA-Grafana existing definitions and setup)

' --- NEW SECURITY CONNECTIONS ---
Dev -> AAD : Authenticates via
AAD -> LB : SSO / OAuth for Grafana

KV <-[#AB47BC]-> Gateway : mTLS Certificates
KV <-[#AB47BC]-> Grafana : Secrets (via MI)
KV <-[#AB47BC]-> Nginx : TLS Certificates

MI -[#AB47BC]-> KV : Authenticates to
MI -[#AB47BC]-> Blob : Writes to (e.g., Loki)

Audit <-[#AB47BC]- KV : Audit Logs
Audit <-[#AB47BC]- VMSS : Activity Logs

note right of MI
  <b>Least Privilege Access:</b>
  MI for Grafana has 'Get' secret permission.
  MI for VMSS has 'Read' blob permission.
end note

legend right
  ... (HA-Grafana existing definitions legend)
  | <color:#AB47BC>#AB47BC</color> | Security & IAM |
end legend
