kubectl logs loki-compactor-0 -n monitoring
failed parsing config: /etc/loki/config/config.yaml: yaml: unmarshal errors:
  line 98: field use_workload_identity not found in type azure.BlobStorageConfig. Use `-config.expand-env=true` flag if you want to expand environment variables in your config file


patches:
  - target:
      kind: StatefulSet
      name: loki-ingester
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
  
  - target:
      kind: Deployment
      name: loki-distributor
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
  
  - target:
      kind: Deployment
      name: loki-querier
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
  
  - target:
      kind: Deployment
      name: loki-query-frontend
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
  
  - target:
      kind: Deployment
      name: loki-query-scheduler
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: 50m
            memory: 100Mi
          requests:
            cpu: 25m
            memory: 50Mi
  
  - target:
      kind: StatefulSet
      name: loki-compactor
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
  
  - target:
      kind: StatefulSet
      name: loki-index-gateway
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
  
  - target:
      kind: Deployment
      name: loki-ruler
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
  
  - target:
      kind: Deployment
      name: loki-gateway
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          limits:
            cpu: 50m
            memory: 64Mi
          requests:
            cpu: 25m
            memory: 32Mi
  
  - target:
      kind: ServiceAccount
      name: oss-sa
    patch: |-
      - op: replace
        path: /metadata/annotations/azure.workload.identity~1client-id
        value: "ACTUAL_CLIENT_ID_HERE"
























error: no resource matches strategic merge patch "StatefulSet.v1.apps/loki-ingester.monitoring": no matches for Id StatefulSet.v1.apps/loki-ingester.monitoring; failed to find unique target for patch StatefulSet.v1.apps/loki-ingester.monitoring
DONE app loki


###############################################################################
# helm/loki/values.yaml
###############################################################################
loki:
  auth_enabled: false
  
  commonConfig:
    replication_factor: 1
  
  storage:
    type: azure
    azure:
      accountName: eddv1sa01
      useManagedIdentity: true
      containerName: loki
      endpointSuffix: blob.core.windows.net
    
    bucketNames:
      chunks: loki
      ruler: ruler
      admin: loki-admin
  
  schemaConfig:
    configs:
      - from: "2024-01-01"
        store: tsdb
        object_store: azure
        schema: v13
        index:
          prefix: loki_index_
          period: 24h
  
  limits_config:
    retention_period: 744h
    ingestion_rate_mb: 10
    ingestion_burst_size_mb: 20
    max_global_streams_per_user: 10000
    per_stream_rate_limit: 5MB
    per_stream_rate_limit_burst: 15MB
  
  compactor:
    working_directory: /var/loki/compactor
    compaction_interval: 10m
    retention_enabled: true
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
  
  ingester:
    chunk_encoding: snappy
    chunk_target_size: 1536000
    chunk_retain_period: 30s
    max_chunk_age: 2h
  
  querier:
    max_concurrent: 2
  
  query_scheduler:
    max_outstanding_requests_per_tenant: 256
  
  storage_config:
    tsdb_shipper:
      active_index_directory: /var/loki/index
      cache_location: /var/loki/cache
    
    azure:
      account_name: eddv1sa01
      use_managed_identity: true
      container_name: loki
      endpoint_suffix: blob.core.windows.net

# Deployment mode
deploymentMode: Distributed

# Enterprise features
enterprise:
  enabled: false

# Loki components
ingester:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi
  persistence:
    enabled: false

distributor:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

querier:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

queryFrontend:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

queryScheduler:
  replicas: 1
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

compactor:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

indexGateway:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

ruler:
  enabled: true
  replicas: 1
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

gateway:
  enabled: true
  replicas: 1
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

# Service Account
serviceAccount:
  create: false
  name: oss-sa

# Monitoring
monitoring:
  selfMonitoring:
    enabled: false
    grafanaAgent:
      installOperator: false

# Test pods
test:
  enabled: false

# Caching
chunksCache:
  enabled: false

resultsCache:
  enabled: false

# Single Binary mode disabled
singleBinary:
  replicas: 0

# Backend components (legacy, v6.31.0 uses individual components)
backend:
  replicas: 0

read:
  replicas: 0

write:
  replicas: 0

###############################################################################
# helm/loki/Chart.yaml
###############################################################################
apiVersion: v2
name: loki
version: 1.0.0
dependencies:
  - name: loki
    version: 6.31.0
    repository: https://grafana.github.io/helm-charts

###############################################################################
# kustomize/base/loki/kustomization.yaml
###############################################################################
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring

resources:
  - service-account.yaml
  - namespace.yaml

helmCharts:
  - name: loki
    repo: https://grafana.github.io/helm-charts
    version: 6.31.0
    releaseName: loki
    namespace: monitoring
    valuesFile: ../../../helm/loki/values.yaml

###############################################################################
# kustomize/base/loki/namespace.yaml
###############################################################################
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
  labels:
    name: monitoring
    azure.workload.identity/use: "true"

###############################################################################
# kustomize/base/loki/service-account.yaml
###############################################################################
apiVersion: v1
kind: ServiceAccount
metadata:
  name: oss-sa
  namespace: monitoring
  annotations:
    azure.workload.identity/client-id: "YOUR_MANAGED_IDENTITY_CLIENT_ID"
  labels:
    azure.workload.identity/use: "true"

###############################################################################
# kustomize/overlays/loki/kustomization.yaml
###############################################################################
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring

resources:
  - ../../base/loki

patches:
  - path: resource-limits-patch.yaml
  - path: service-account-patch.yaml

###############################################################################
# kustomize/overlays/loki/resource-limits-patch.yaml
###############################################################################
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: loki-ingester
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-distributor
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-querier
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-query-frontend
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-query-scheduler
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 50m
            memory: 100Mi
          requests:
            cpu: 25m
            memory: 50Mi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: loki-compactor
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: loki-index-gateway
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-ruler
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-gateway
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: nginx
        resources:
          limits:
            cpu: 50m
            memory: 64Mi
          requests:
            cpu: 25m
            memory: 32Mi

###############################################################################
# kustomize/overlays/loki/service-account-patch.yaml
###############################################################################
apiVersion: v1
kind: ServiceAccount
metadata:
  name: oss-sa
  namespace: monitoring
  annotations:
    azure.workload.identity/client-id: "ACTUAL_CLIENT_ID_HERE"

###############################################################################
# DEPLOYMENT INSTRUCTIONS
###############################################################################
# 
# Loki Helm Chart Version: 6.31.0
# 
# Directory Structure:
# .
# ├── helm/
# │   └── loki/
# │       ├── Chart.yaml
# │       └── values.yaml
# ├── kustomize/
# │   ├── base/
# │   │   └── loki/
# │   │       ├── kustomization.yaml
# │   │       ├── namespace.yaml
# │   │       └── service-account.yaml
# │   └── overlays/
# │       └── loki/
# │           ├── kustomization.yaml
# │           ├── resource-limits-patch.yaml
# │           └── service-account-patch.yaml
#
# Key Changes in 6.31.0:
# - Uses individual component deployments instead of backend/read/write
# - Components: ingester, distributor, querier, queryFrontend, queryScheduler,
#   compactor, indexGateway, ruler, gateway
# - Ingester, compactor, and indexGateway use StatefulSets
# - Others use Deployments
#
# Prerequisites:
# 1. Azure Workload Identity enabled on AKS cluster
# 2. Managed Identity 'oss-sa' with Storage Blob Data Contributor role
# 3. Storage account: eddv1sa01
# 4. Containers: loki, loki-admin, ruler
# 5. Federated credential for monitoring namespace
# 6. Update client ID in service-account-patch.yaml
#
# Deploy:
# cd kustomize/overlays/loki
# kustomize build --enable-helm . | kubectl apply -f -
#
# Or:
# kubectl apply -k kustomize/overlays/loki --enable-helm
#
# Verify:
# kubectl get pods -n monitoring
# kubectl get statefulsets -n monitoring
# kubectl logs -n monitoring -l app.kubernetes.io/name=loki --tail=50
#
# Check specific components:
# kubectl get pods -n monitoring -l app.kubernetes.io/component=ingester
# kubectl get pods -n monitoring -l app.kubernetes.io/component=querier
#
# Test Azure Blob Storage:
# kubectl exec -n monitoring statefulset/loki-ingester -c loki -- \
#   wget -O- "https://eddv1sa01.blob.core.windows.net/loki?restype=container"
#
























###############################################################################
# helm/loki/values.yaml
###############################################################################
loki:
  auth_enabled: false
  
  commonConfig:
    replication_factor: 1
  
  storage:
    type: azure
    azure:
      accountName: eddv1sa01
      useManagedIdentity: true
      containerName: loki
      endpointSuffix: blob.core.windows.net
    
    bucketNames:
      chunks: loki
      ruler: ruler
      admin: loki-admin
  
  schemaConfig:
    configs:
      - from: 2024-01-01
        store: tsdb
        object_store: azure
        schema: v13
        index:
          prefix: index_
          period: 24h
  
  limits_config:
    retention_period: 744h
    ingestion_rate_mb: 10
    ingestion_burst_size_mb: 20
    max_global_streams_per_user: 10000
  
  compactor:
    working_directory: /var/loki/compactor
    compaction_interval: 10m
    retention_enabled: true
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
  
  ingester:
    chunk_encoding: snappy
    chunk_target_size: 1536000
    chunk_retain_period: 30s
    max_chunk_age: 2h
  
  querier:
    max_concurrent: 2
  
  query_scheduler:
    max_outstanding_requests_per_tenant: 256

deploymentMode: Distributed

backend:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

read:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

write:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

gateway:
  enabled: true
  replicas: 1
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

serviceAccount:
  create: false
  name: oss-sa

monitoring:
  selfMonitoring:
    enabled: false
    grafanaAgent:
      installOperator: false

test:
  enabled: false

chunksCache:
  enabled: false

resultsCache:
  enabled: false

###############################################################################
# helm/loki/Chart.yaml
###############################################################################
apiVersion: v2
name: loki
version: 1.0.0
dependencies:
  - name: loki
    version: 6.6.4
    repository: https://grafana.github.io/helm-charts

###############################################################################
# kustomize/base/loki/kustomization.yaml
###############################################################################
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring

resources:
  - service-account.yaml
  - namespace.yaml

helmCharts:
  - name: loki
    repo: https://grafana.github.io/helm-charts
    version: 6.6.4
    releaseName: loki
    namespace: monitoring
    valuesFile: ../../../helm/loki/values.yaml

###############################################################################
# kustomize/base/loki/namespace.yaml
###############################################################################
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
  labels:
    name: monitoring

###############################################################################
# kustomize/base/loki/service-account.yaml
###############################################################################
apiVersion: v1
kind: ServiceAccount
metadata:
  name: oss-sa
  namespace: monitoring
  annotations:
    azure.workload.identity/client-id: "YOUR_MANAGED_IDENTITY_CLIENT_ID"
  labels:
    azure.workload.identity/use: "true"

###############################################################################
# kustomize/overlays/loki/kustomization.yaml
###############################################################################
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring

resources:
  - ../../base/loki

patches:
  - path: resource-limits-patch.yaml
  - path: service-account-patch.yaml

###############################################################################
# kustomize/overlays/loki/resource-limits-patch.yaml
###############################################################################
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-backend
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-read
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-write
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-gateway
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: nginx
        resources:
          limits:
            cpu: 50m
            memory: 64Mi
          requests:
            cpu: 25m
            memory: 32Mi

###############################################################################
# kustomize/overlays/loki/service-account-patch.yaml
###############################################################################
apiVersion: v1
kind: ServiceAccount
metadata:
  name: oss-sa
  namespace: monitoring
  annotations:
    azure.workload.identity/client-id: "ACTUAL_CLIENT_ID_HERE"

###############################################################################
# DEPLOYMENT INSTRUCTIONS
###############################################################################
# 
# Directory Structure:
# .
# ├── helm/
# │   └── loki/
# │       ├── Chart.yaml
# │       └── values.yaml
# ├── kustomize/
# │   ├── base/
# │   │   └── loki/
# │   │       ├── kustomization.yaml
# │   │       ├── namespace.yaml
# │   │       └── service-account.yaml
# │   └── overlays/
# │       └── loki/
# │           ├── kustomization.yaml
# │           ├── resource-limits-patch.yaml
# │           └── service-account-patch.yaml
#
# Prerequisites:
# 1. Azure Workload Identity enabled on AKS cluster
# 2. Managed Identity 'oss-sa' created with Storage Blob Data Contributor role
# 3. Containers created in eddv1sa01: loki, loki-admin, ruler
# 4. Federated credential configured for monitoring namespace
# 5. Update YOUR_MANAGED_IDENTITY_CLIENT_ID in service-account-patch.yaml
#
# Deploy:
# cd kustomize/overlays/loki
# kustomize build --enable-helm . | kubectl apply -f -
#
# Or using kubectl:
# kubectl apply -k kustomize/overlays/loki --enable-helm
#
# Verify:
# kubectl get pods -n monitoring
# kubectl logs -n monitoring -l app.kubernetes.io/name=loki
#
# Test Azure Blob Storage:
# kubectl exec -n monitoring deployment/loki-backend -c loki -- \
#   wget -O- "https://eddv1sa01.blob.core.windows.net/loki?restype=container"
#




├── cluster
│   ├── base
│   └── overlays
├── helm
│       ├── loki
├── kustomize
│   ├── base
│   │   ├── loki
│   └── overlays
│       │   ├── loki

---
# kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring

helmCharts:
  - name: loki
    repo: https://grafana.github.io/helm-charts
    version: 6.6.4
    releaseName: loki
    namespace: monitoring
    valuesFile: loki-values.yaml

resources:
  - service-account.yaml

# Apply additional resource patches
patches:
  - path: resource-patches.yaml

---
# loki-values.yaml
loki:
  auth_enabled: false
  
  commonConfig:
    replication_factor: 1
  
  storage:
    type: azure
    azure:
      accountName: eddv1sa01
      # Using managed identity - no accountKey needed
      useManagedIdentity: true
      containerName: loki
      endpointSuffix: blob.core.windows.net
    
    bucketNames:
      chunks: loki
      ruler: loki
      admin: loki-admin
  
  schemaConfig:
    configs:
      - from: 2024-01-01
        store: tsdb
        object_store: azure
        schema: v13
        index:
          prefix: index_
          period: 24h
  
  limits_config:
    retention_period: 744h
    ingestion_rate_mb: 10
    ingestion_burst_size_mb: 20
    max_global_streams_per_user: 10000
  
  compactor:
    working_directory: /var/loki/compactor
    compaction_interval: 10m
    retention_enabled: true
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
  
  ingester:
    chunk_encoding: snappy
    chunk_target_size: 1536000
    chunk_retain_period: 30s
    max_chunk_age: 2h
  
  querier:
    max_concurrent: 2
  
  query_scheduler:
    max_outstanding_requests_per_tenant: 256

# Microservice mode components
deploymentMode: Distributed

# Backend (Ingester, Store Gateway, Compactor)
backend:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# Read component (Query Frontend, Querier)
read:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# Write component (Distributor)
write:
  replicas: 1
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

# Gateway
gateway:
  enabled: true
  replicas: 1
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

# Service Account configuration
serviceAccount:
  create: false
  name: oss-sa
  annotations:
    azure.workload.identity/client-id: ""  # Add your managed identity client ID

# Monitoring
monitoring:
  selfMonitoring:
    enabled: false
    grafanaAgent:
      installOperator: false

# Disable test pods
test:
  enabled: false

# Chunk cache
chunksCache:
  enabled: false

# Results cache
resultsCache:
  enabled: false

---
# service-account.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: oss-sa
  namespace: monitoring
  annotations:
    azure.workload.identity/client-id: "YOUR_MANAGED_IDENTITY_CLIENT_ID"
  labels:
    azure.workload.identity/use: "true"

---
# loki-runtime-config.yaml (Optional - for ruler if needed)
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-runtime
  namespace: monitoring
data:
  runtime-config.yaml: |
    overrides:
      "fake":
        ingestion_rate_mb: 10
        ingestion_burst_size_mb: 20
        max_global_streams_per_user: 10000

---
# Deployment Instructions:
# 
# 1. Prerequisites:
#    - Azure Workload Identity enabled on your AKS cluster
#    - Managed Identity 'oss-sa' created with Storage Blob Data Contributor role on eddv1sa01
#    - Containers created: loki, loki-admin, ruler
#    - Federated credential configured for oss-sa with monitoring namespace
#
# 2. Update the client ID:
#    Replace YOUR_MANAGED_IDENTITY_CLIENT_ID in service-account.yaml with actual client ID
#
# 3. Deploy using Kustomize with Helm:
#    kubectl create namespace monitoring
#    kustomize build --enable-helm . | kubectl apply -f -
#
# 4. Verify deployment:
#    kubectl get pods -n monitoring
#    kubectl logs -n monitoring -l app.kubernetes.io/name=loki --tail=50
#
# 5. Test Azure Blob Storage access:
#    kubectl exec -n monitoring deployment/loki-backend -c loki -- \
#      wget -O- "https://eddv1sa01.blob.core.windows.net/loki?restype=container"

---
# Alternative: patch.yaml for further resource reduction
# resource-patches.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-backend
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-read
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-write
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: loki
        resources:
          limits:
            cpu: 150m
            memory: 200Mi
          requests:
            cpu: 50m
            memory: 100Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki-gateway
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: nginx
        resources:
          limits:
            cpu: 50m
            memory: 64Mi
          requests:
            cpu: 25m
            memory: 32Mi
