# loki-pvc-values.yaml
loki:
  commonConfig:
    replication_factor: 1
  storage:
    type: 'filesystem'  # Using PVC for storage
    bucketNames:
      chunks: loki-chunks
      ruler: loki-rules
      admin: loki-admin
  schemaConfig:
    configs:
      - from: "2024-04-01"
        store: tsdb
        object_store: filesystem
        schema: v13
        index:
          prefix: loki_index_
          period: 24h
  storage_config:
    filesystem:
      directory: /var/loki/storage  # PVC mount path
  limits_config:
    ingestion_rate_mb: 4
    ingestion_burst_size_mb: 6
    retention_period: "168h"  # 7 days retention

# Disable unnecessary components
minio:
  enabled: false
gateway:
  enabled: false

# Single Binary mode with PVC
deploymentMode: SingleBinary
singleBinary:
  replicas: 2  # For basic HA
  persistence:
    enabled: true
    storageClass: managed-csi-premium  # Azure Premium SSD
    accessModes:
      - ReadWriteOnce
    size: 100Gi  # Minimum recommended for production
    annotations:
      volume.beta.kubernetes.io/storage-class: managed-csi-premium
  securityContext:
    fsGroup: 10001
    runAsUser: 10001
    runAsGroup: 10001
  resources:
    requests:
      cpu: "1"
      memory: "4Gi"
    limits:
      cpu: "2"
      memory: "8Gi"
  podAnnotations:
    cluster-autoscaler.kubernetes.io/safe-to-evict: "false"  # Prevent eviction during scaling

# Monitoring and health checks
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
  livenessProbe:
    httpGet:
      path: /ready
      port: http-metrics
    initialDelaySeconds: 45
    periodSeconds: 10
  readinessProbe:
    httpGet:
      path: /ready
      port: http-metrics
    initialDelaySeconds: 15
    periodSeconds: 5

# Service configuration
service:
  type: ClusterIP
  ports:
    - name: http-metrics
      port: 3100
      targetPort: http-metrics
    - name: grpc
      port: 9095
      targetPort: grpc

# PVC retention policy (requires Kubernetes 1.23+)
persistentVolume:
  reclaimPolicy: Retain  # Prevents accidental data loss

# Recommended for AKS
podDisruptionBudget:
  maxUnavailable: 1
