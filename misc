az ad sp list --filter "displayName eq 'Azure Monitor'" --query "[].{Name:displayName, ObjectId:objectId, AppId:appId}" --output table


az ad app list --query "[].{appId:appId, displayName:displayName}" -o table


# For a specific application (replace with your app name)
clientId=$(az ad app list --display-name "YourAppName" --query [].appId -o tsv)
echo "Client ID: $clientId"

# List all applications and their client IDs
az ad app list --query '[].{displayName:displayName, appId:appId}' -o table


# Assign Key Vault access to AKS cluster's managed identity
az keyvault set-policy --name Goodvault --object-id $(az aks show -g <resource-group> -n <aks-name> --query identity.principalId -o tsv) --secret-permissions get list

#########

Identify the AKS Cluster's Managed Identity
First, determine the principal ID of your AKS cluster's managed identity:
Assign Key Vault Access Policy
Grant the necessary permissions to the managed identity:
Verify the Access Policy
Confirm the policy was applied correctly:
Configure AKS to Use Key Vault Secrets (Optional)
If you want to use Azure Key Vault Provider for Secrets Store CSI Driver:


# Get the principal ID of the AKS cluster's managed identity
AKS_RESOURCE_GROUP="your-aks-resource-group"
AKS_NAME="your-aks-cluster-name"

PRINCIPAL_ID=$(az aks show \
  --resource-group $AKS_RESOURCE_GROUP \
  --name $AKS_NAME \
  --query "identity.principalId" \
  --output tsv)

echo "Principal ID: $PRINCIPAL_ID"

###Grant the necessary permissions to the managed identity:

KEY_VAULT_NAME="Goodvault"
KEY_VAULT_RESOURCE_GROUP="your-keyvault-resource-group"

# Assign get and list permissions for secrets
az keyvault set-policy \
  --name $KEY_VAULT_NAME \
  --resource-group $KEY_VAULT_RESOURCE_GROUP \
  --object-id $PRINCIPAL_ID \
  --secret-permissions get list

### Confirm the policy was applied correctly:

az keyvault show \
  --name $KEY_VAULT_NAME \
  --resource-group $KEY_VAULT_RESOURCE_GROUP \
  --query "properties.accessPolicies[?objectId=='$PRINCIPAL_ID']"


#########################
Grafana deployment issue

Error: Unable to continue with install: could not get information about the resource ClusterRole "grafana-clusterrole" in namespace "": clusterroles.rbac.authoriz


2025-04-17T01:30:02.1374653Z [command]/azp/agent/_work/_tool/helm/3.17.3/x64/linux-amd64/helm upgrade --namespace eddv3-hbt --install --values /azp/agent/_work/56/s/devops/helm-charts/grafana-monitor/grafana-values-dev.yaml --wait --timeout 10m0s --create-namespace grafana grafana/grafana --version 8.11.4
2025-04-17T01:30:03.4488065Z Error: Unable to continue with install: could not get information about the resource ClusterRole "grafana-clusterrole" in namespace "": clusterroles.rbac.authorization.k8s.io "grafana-clusterrole" is forbidden: User "e524bd2f-9cc8-4a65-8a5c-d7407061fc82" cannot get resource "clusterroles" in API group "rbac.authorization.k8s.io" at the cluster scope
2025-04-17T01:30:03.4488528Z Release "grafana" does not exist. Installing it now.
2025-04-17T01:30:03.4524145Z ##[error]Error: Unable to continue with install: could not get information about the resource ClusterRole "grafana-clusterrole" in namespace "": clusterroles.rbac.authorization.k8s.io "grafana-clusterrole" is forbidden: User "e524bd2f-9cc8-4a65-8a5c-d7407061fc82" cannot get resource "clusterroles" in API group "rbac.authorization.k8s.io" at the cluster scope

2025-04-17T01:30:03.4633833Z ##[section]Finishing: Deploy Grafana Helm Chart
Solution
========


# Create RBAC resources for External Secrets
kubectl apply -f - <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-secrets-access
rules:
- apiGroups: ["external-secrets.io"]
  resources: ["secretstores", "externalsecrets", "clustersecretstores"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-secrets-binding
subjects:
- kind: ServiceAccount
  name: SP
  namespace: comm-dev
roleRef:
  kind: ClusterRole
  name: external-secrets-access
  apiGroup: rbac.authorization.k8s.io
EOF
