@startuml C4_Level1_HA_Grafana

!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

title <color:#0078D4>HA-Grafana Observability - C4 Level 1 (System Context)</color>

LAYOUT_WITH_LEGEND()

' --- People ---
Person(dev, "Developers / SRE", "Use Grafana dashboards for monitoring & troubleshooting")

' --- Main System ---
System_Boundary(grafana_stack, "HA-Grafana Observability Stack") {
    System(grafana, "HA-Grafana", "Dashboards and visualization platform")
}

' --- External Systems (Security & Identity Foundation) ---
System_Ext(aad, "Azure Active Directory", "Authentication & SSO (OAuth)")
System_Ext(kv, "Azure Key Vault", "Secrets, Certificates, Keys")
System_Ext(mi, "Azure Managed Identities", "Identity for VMSS & Apps")
System_Ext(audit, "Loki / Audit Logs", "System & Access logs storage")
System_Ext(blob, "Azure Blob Storage", "Metrics & trace object storage (Thanos, Loki chunks)")
System_Ext(gateway, "Gateway / Ingress (NGINX)", "Routes traffic securely to Grafana")

' --- Relationships ---
Rel(dev, aad, "Authenticates via")
Rel(aad, grafana, "SSO / OAuth for access")

Rel(kv, gateway, "mTLS Certificates")
Rel(kv, grafana, "Secrets (via MI)")
Rel(kv, gateway, "TLS Certificates")

Rel(mi, kv, "Authenticates to")
Rel(mi, blob, "Writes to (Thanos, Loki chunks)")

Rel_Back(audit, kv, "Access Logs")
Rel_Back(audit, grafana_stack, "Syslogs / Activity Logs (via Alloy)")

' --- Notes ---
Note right of mi
  <b>Least Privilege Access:</b>\n
  - Grafana MI: Get Secret\n
  - VMSS MI: Read Blob
end note

' --- Legend ---
UpdateElementStyle(System_Ext, $bgColor="#AB47BC", $fontColor="white")
AddElementTag("Security", $bgColor="#AB47BC", $fontColor="white")

legend right
  | <color:#AB47BC>#AB47BC</color> | Security & IAM |
end legend

@enduml
